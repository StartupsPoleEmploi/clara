require "test_helper"

class PeConnectTokenTest < ActiveSupport::TestCase
  

  test '.call? returns an access_token and an id_token' do
    #given
    resp = OpenStruct.new(body: typical_remote_response_body)
    # expectations
    allow(ENV).to receive(:[]).with('ESD_CLIENTSECRET').and_return('ESD_CLIENTSECRET')
    allow(ENV).to receive(:[]).with('ESD_CLIENTID').and_return('ESD_CLIENTID')
    allow_any_instance_of(HttpService).to receive(:post_form).and_return(resp)
    #when
    res = PeConnectToken.new.call('mybase', 'mycode')
    #then
    assert_equal(expected_anwser, res)
  end
  
  def typical_remote_response_body
    "{\"access_token\":\"LFJWIhnmPWatXchGcG94ZTwjvr4\",\"scope\":\"api_peconnect-formationsv1 application_PAR_clara_a379c152af8329de7accfed10e37680c726e7db688e6c6436dc6c2d4cea7c381 openid profile api_peconnect-individuv1 api_peconnect-datenaissancev1 api_peconnect-indemnisationsv1 coordonnees pfcformations api_peconnect-coordonneesv1 api_peconnect-statutv1 datenaissance indemnisation email statut\",\"id_token\":\"eyJ0eXAiOiJKV1QiLCJraWQiOiJPN1pUVkIzMHVCY3FhNFovVHN4bVNXR21JRzQ9IiwiYWxnIjoiUlMyNTYifQ.eyJpZElkZW50aXRlRXh0ZXJuZSI6IjliY2I5MmQ5LTZhN2ItNDY0ZC05YjQ2LThjMjhhZjJiNWFmMSIsImF0X2hhc2giOiJ1SzdiYVRiT1ZhRFk1X3RLWExOQlRRIiwic3ViIjoiOWJjYjkyZDktNmE3Yi00NjRkLTliNDYtOGMyOGFmMmI1YWYxIiwiZ2VuZGVyIjoibWFsZSIsImF1ZGl0VHJhY2tpbmdJZCI6ImY5NGMzZDhlLWNiOGItNDJhMS05MThkLWI1YTUwODU4N2FhZi0xMzMwODY4MCIsImlzcyI6Imh0dHBzOi8vYXV0aGVudGlmaWNhdGlvbi1jYW5kaWRhdC5wb2xlLWVtcGxvaS5mcjo0NDMvY29ubmV4aW9uL29hdXRoMi9yZWFsbXMvcm9vdC9yZWFsbXMvaW5kaXZpZHUiLCJ0b2tlbk5hbWUiOiJpZF90b2tlbiIsImdpdmVuX25hbWUiOiJST0JFUlQiLCJub25jZSI6IjM4MTExYTlmMWI5YjM4NTJhNmU0MmM2YzFkMTE0NzFhNDJlNWIyYzQiLCJhdWQiOiJQQVJfY2xhcmFfYTM3OWMxNTJhZjgzMjlkZTdhY2NmZWQxMGUzNzY4MGM3MjZlN2RiNjg4ZTZjNjQzNmRjNmMyZDRjZWE3YzM4MSIsImNfaGFzaCI6InZiemI3OWRRMk5TMlJZSmpEU1dxNWciLCJhY3IiOiIwIiwib3JnLmZvcmdlcm9jay5vcGVuaWRjb25uZWN0Lm9wcyI6InZYYUtFZElpZHRwZnBYMkhHa2lnY0xRRE1PUSIsInNfaGFzaCI6ImR0WVNxMDlOd2hxWk9VUzQ4Tnh3NnciLCJ1cGRhdGVkX2F0IjowLCJhenAiOiJQQVJfY2xhcmFfYTM3OWMxNTJhZjgzMjlkZTdhY2NmZWQxMGUzNzY4MGM3MjZlN2RiNjg4ZTZjNjQzNmRjNmMyZDRjZWE3YzM4MSIsImF1dGhfdGltZSI6MTYyMzY3MjMyMywicmVhbG0iOiIvaW5kaXZpZHUiLCJleHAiOjE2MjM2NzU5MjMsInRva2VuVHlwZSI6IkpXVFRva2VuIiwiZmFtaWx5X25hbWUiOiJNQVJDSEFORCIsImlhdCI6MTYyMzY3MjMyMywiZW1haWwiOiJlbXBsb2lzdG9yZWRldkBnbWFpbC5jb20ifQ.Zi9C3XGsx_xck4V_nH8chuQ_USlS5qtKC5qL4aZQ7-ryUXOO7l5R5EAqBXj3LpbWi46-Db0zyacrYS5eiOQo68l4ymDUkAz4muAf8CgqghPzgPr3vlHgEQN0xFKlyCsWhfpbwGh4nMvxbvC_vtPPsuRMuUDWyKLt8oTqqYJwieSzBq_UPwFrQDwq6IOiNA-XRPq7DA0wsECWK_qSHxElg-i8odHxz4N7dWi332wc0ggtsN-SUCg_w62m3QdLY-l0hStNgj3NA17eBaNhWxqxERsVByjQsyzWjSVUzbGZEvYP-0ufqgKWcVgSXms8qFwX1wbgkian-rrzTo5v_W1Hkw\",\"token_type\":\"Bearer\",\"expires_in\":1139,\"nonce\":\"38111a9f1b9b3852a6e42c6c1d11471a42e5b2c4\"}"
  end

  def expected_anwser
    {:id_token=>"eyJ0eXAiOiJKV1QiLCJraWQiOiJPN1pUVkIzMHVCY3FhNFovVHN4bVNXR21JRzQ9IiwiYWxnIjoiUlMyNTYifQ.eyJpZElkZW50aXRlRXh0ZXJuZSI6IjliY2I5MmQ5LTZhN2ItNDY0ZC05YjQ2LThjMjhhZjJiNWFmMSIsImF0X2hhc2giOiJ1SzdiYVRiT1ZhRFk1X3RLWExOQlRRIiwic3ViIjoiOWJjYjkyZDktNmE3Yi00NjRkLTliNDYtOGMyOGFmMmI1YWYxIiwiZ2VuZGVyIjoibWFsZSIsImF1ZGl0VHJhY2tpbmdJZCI6ImY5NGMzZDhlLWNiOGItNDJhMS05MThkLWI1YTUwODU4N2FhZi0xMzMwODY4MCIsImlzcyI6Imh0dHBzOi8vYXV0aGVudGlmaWNhdGlvbi1jYW5kaWRhdC5wb2xlLWVtcGxvaS5mcjo0NDMvY29ubmV4aW9uL29hdXRoMi9yZWFsbXMvcm9vdC9yZWFsbXMvaW5kaXZpZHUiLCJ0b2tlbk5hbWUiOiJpZF90b2tlbiIsImdpdmVuX25hbWUiOiJST0JFUlQiLCJub25jZSI6IjM4MTExYTlmMWI5YjM4NTJhNmU0MmM2YzFkMTE0NzFhNDJlNWIyYzQiLCJhdWQiOiJQQVJfY2xhcmFfYTM3OWMxNTJhZjgzMjlkZTdhY2NmZWQxMGUzNzY4MGM3MjZlN2RiNjg4ZTZjNjQzNmRjNmMyZDRjZWE3YzM4MSIsImNfaGFzaCI6InZiemI3OWRRMk5TMlJZSmpEU1dxNWciLCJhY3IiOiIwIiwib3JnLmZvcmdlcm9jay5vcGVuaWRjb25uZWN0Lm9wcyI6InZYYUtFZElpZHRwZnBYMkhHa2lnY0xRRE1PUSIsInNfaGFzaCI6ImR0WVNxMDlOd2hxWk9VUzQ4Tnh3NnciLCJ1cGRhdGVkX2F0IjowLCJhenAiOiJQQVJfY2xhcmFfYTM3OWMxNTJhZjgzMjlkZTdhY2NmZWQxMGUzNzY4MGM3MjZlN2RiNjg4ZTZjNjQzNmRjNmMyZDRjZWE3YzM4MSIsImF1dGhfdGltZSI6MTYyMzY3MjMyMywicmVhbG0iOiIvaW5kaXZpZHUiLCJleHAiOjE2MjM2NzU5MjMsInRva2VuVHlwZSI6IkpXVFRva2VuIiwiZmFtaWx5X25hbWUiOiJNQVJDSEFORCIsImlhdCI6MTYyMzY3MjMyMywiZW1haWwiOiJlbXBsb2lzdG9yZWRldkBnbWFpbC5jb20ifQ.Zi9C3XGsx_xck4V_nH8chuQ_USlS5qtKC5qL4aZQ7-ryUXOO7l5R5EAqBXj3LpbWi46-Db0zyacrYS5eiOQo68l4ymDUkAz4muAf8CgqghPzgPr3vlHgEQN0xFKlyCsWhfpbwGh4nMvxbvC_vtPPsuRMuUDWyKLt8oTqqYJwieSzBq_UPwFrQDwq6IOiNA-XRPq7DA0wsECWK_qSHxElg-i8odHxz4N7dWi332wc0ggtsN-SUCg_w62m3QdLY-l0hStNgj3NA17eBaNhWxqxERsVByjQsyzWjSVUzbGZEvYP-0ufqgKWcVgSXms8qFwX1wbgkian-rrzTo5v_W1Hkw", :access_token=>"LFJWIhnmPWatXchGcG94ZTwjvr4"}
  end

end
